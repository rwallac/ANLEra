#textdomain wesnoth-ANLEra

[multiplayer]
    id=ANLEra_Silver
    name= _ "2p — ANL Silverhead"
    map_file=~add-ons/ANLEra/maps/2p_ANL_Silverhead.map
    description= _ "This 2p survival scenario allows you to construct buildings and terraform the land. Use map settings."
    experience_modifier=70%

    allow_era=ANLEra,JoyCamp

    {DEFAULT_SCHEDULE}
    {DEFAULT_MUSIC_PLAYLIST}
    # ------------------------------------------------------
    # Include ANL macros
    # ------------------------------------------------------
    {ENABLE_TRAPPED_CREATURES}

    # Not included in mechanism.cfg
    # Cannot use "side 1 turn", because it happens after "side turn", and the worked_this_turn status is reset during "side turn".
    # That is why this event is at the end of the previous turn instead.
    # Could also use "side turn" and [filter_side] tag to filter for side 1,2 but that is new in 1.19.
    [event]
        name=side 1 turn end,side 2 turn end
        first_time_only=no
        {AUTO_MUSHROOM "Goblin Spearman,Goblin Impaler,Goblin Rouser,Peasant,Ruffian,Woodsman,ANLEra Dwarvish Miner,Dwarvish Miner,ANLEra Elvish Civilian,ANLEra Drake Worker,ANLEra Young Saurian,ANLEra Dune Civilian,Walking Corpse,Soulless"}
        {AUTO_CLEANUP "Goblin Spearman,Goblin Impaler,Goblin Rouser,Peasant,Ruffian,Woodsman,ANLEra Dwarvish Miner,Dwarvish Miner,ANLEra Elvish Civilian,ANLEra Drake Worker,ANLEra Young Saurian,ANLEra Dune Civilian,Walking Corpse,Soulless,ANLEra Merman Citizen,Merman Citizen"}
    [/event]

    # ------------------------------------------------------
    # Teleport bidirectional
    # ------------------------------------------------------

    [event]
        name=prestart

        [tunnel]
            [filter]
                [not]
                    # Spiders can't use it.
                    side=8
                [/not]
                [not]
                    type=Giant Spider
                [/not]
            [/filter]
            [source]
                x=1,41
                y=11,17
            [/source]
            [target]
                x=21
                y=14
            [/target]
            bidirectional=yes
        [/tunnel]
    [/event]

    {PLACE_IMAGE "scenery/rune2-glow.png" 1 11}
    {PLACE_IMAGE "scenery/rune2-glow.png" 41 17}
    {PLACE_IMAGE "scenery/rune2-glow.png" 21 14}

    # ------------------------------------------------------
    # Story & Objectives
    # ------------------------------------------------------
    {OBJECTIVES_ANL}

    # ------------------------------------------------------
    # Side Definitions
    # ------------------------------------------------------

    # Players sides

    [side]
        side=1
        controller=human
        #textdomain wesnoth-anl
        team_name=1
        user_team_name= _ "teamname^Settlers"
        team_lock=yes
        income_lock=yes
        village_gold=2
        gold=100
        shroud=no
        fog=yes
    [/side]

    [side]
        side=2
        controller=human
        team_name=1
        user_team_name= _ "teamname^Settlers"
        team_lock=yes
        income_lock=yes
        village_gold=2
        gold=100
        shroud=no
        fog=yes
    [/side]

    # AI sides

    [side]
        side=3
        canrecruit=yes
        controller=ai
        allow_player=no
        disallow_observers=yes
        team_name=2
        user_team_name= _ "teamname^Enemies"
        gold=25
        recruit=Walking Corpse
        income=11
        village_gold=2
        team_lock=yes
        income_lock=yes
        controller_lock=yes
        faction_lock=yes
        faction=Custom
        type=Death Knight
        [modifications]
            {MOVEMENT_RESTRICTION}
        [/modifications]
        [ai]
            aggression=1.0
            recruitment_more="2"
            recruitment_pattern=fighter
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 3 main_loop retreat_injured}
        [/ai]
    [/side]

    [side]
        side=4
        canrecruit=yes
        controller=ai
        allow_player=no
        disallow_observers=yes
        team_name=2
        user_team_name= _ "teamname^Enemies"
        gold=25
        recruit=Goblin Spearman
        income=11
        village_gold=2
        team_lock=yes
        income_lock=yes
        controller_lock=yes
        faction_lock=yes
        faction=Custom
        type=Orcish Sovereign
        [modifications]
            {MOVEMENT_RESTRICTION}
        [/modifications]
        [ai]
            aggression=1.0
            recruitment_more="2"
            recruitment_pattern=fighter
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 4 main_loop retreat_injured}
        [/ai]
    [/side]

    [side]
        side=5
        canrecruit=yes
        controller=ai
        allow_player=no
        disallow_observers=yes
        team_name=2
        user_team_name= _ "teamname^Enemies"
        gold=25
        recruit=Walking Corpse
        income=11
        village_gold=2
        team_lock=yes
        income_lock=yes
        controller_lock=yes
        faction_lock=yes
        faction=Custom
        type=Lich
        [modifications]
            {MOVEMENT_RESTRICTION}
        [/modifications]
        [ai]
            aggression=1.0
            recruitment_more="2"
            recruitment_pattern=fighter
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 5 main_loop retreat_injured}
        [/ai]
    [/side]

    [side]
        side=6
        canrecruit=yes
        controller=ai
        allow_player=no
        disallow_observers=yes
        team_name=2
        user_team_name= _ "teamname^Enemies"
        gold=25
        recruit=Goblin Spearman
        income=11
        village_gold=2
        team_lock=yes
        income_lock=yes
        controller_lock=yes
        faction_lock=yes
        faction=Custom
        type=Orcish Sovereign
        [modifications]
            {MOVEMENT_RESTRICTION}
        [/modifications]
        [ai]
            aggression=1.0
            recruitment_more="2"
            recruitment_pattern=fighter
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 6 main_loop retreat_injured}
        [/ai]
    [/side]

    # This side is for trapped units. It is allied to the AI so they don't attack it.

    [side]
        side=7
        controller=null
        allow_player=no
        disallow_observers=yes
        hidden=yes # Not visible in alt+s.
        no_leader=yes
        # Needs to be on the same team as monsters.
        # You can attack them, but you free them when staring to attack.
        # Could be in multiple teams, but that does not work when map settings are not used.
        # Would need team_lock=yes and force_map_settings=yes.
        team_name=monsters
        user_team_name= _ "teamname^Prisoners"
        share_vision=none
        income=2
        village_gold=0
        village_support=0
        team_lock=yes
        gold_lock=yes
        income_lock=yes
        controller_lock=yes
        faction_lock=yes
        faction=Custom
        [ai]
            ai_algorithm=idle_ai
        [/ai]
    [/side]

    # Optionally can put spiders and dwarves on a different side.
    [side]
        side=8
        color=lightblue
        controller=ai
        allow_player=no
        disallow_observers=yes
        hidden=yes # Not visible in alt+s.
        no_leader=yes
        team_name=monsters # Can attack the ai enemies too.
        user_team_name= _ "teamname^Monsters"
        share_vision=none
        #textdomain wesnoth-ANLEra
        gold=0
        income=0
        village_gold=0
        village_support=0
        team_lock=no
        color_lock=no
        gold_lock=yes
        income_lock=yes
        leader_lock=yes
        controller_lock=yes
        faction=Custom
        [ai]
            aggression=1.0
            village_value=0
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 8 main_loop retreat_injured}
        [/ai]
    [/side]

    # ------------------------------------------------------
    # Scenario Events
    # ------------------------------------------------------

    [event]
        name=prestart

        # Placing trapped creatures
        {RANDOM yes,no}
        [if]
            {VARIABLE_CONDITIONAL random boolean_equals yes}
            [then]
                {TRAPPED_CREATURE_WOSE 20 6  "Elder Wose" 7 "1,2"}
                {TRAPPED_CREATURE_CAGE 23 20 "Mermaid Enchantress" 7 "1,2" TRAIT={TRAIT_RESILIENT}}
            [/then]
            [else]
                {TRAPPED_CREATURE_CAGE 20 6  "Mermaid Enchantress" 7 "1,2" TRAIT={TRAIT_RESILIENT}}
                {TRAPPED_CREATURE_WEB  23 20 "Fire Drake" 7 "1,2"}
            [/else]
        [/if]
        {CLEAR_VARIABLE random}

        # Placing spiders side number
        {ANL_PLACE_WOUNDED_UNIT 8 "Giant Spider" 26 18 4} # Or on side 3.
        {ANL_PLACE_WOUNDED_UNIT 8 "Giant Spider" 19 9 4}  # Or on side 6.

        # Initial AI units - Side 3 - corpse at mine and revenant as guard
        #                 {ANL_PLACE_UNIT 3 "Walking Corpse" 40 11}
        #                 {ANL_PLACE_UNIT 3 "Walking Corpse" 40 11}
        #                 {ANL_PLACE_UNIT 3 "Walking Corpse" 40 11}

        #
        #                 [unit]
        #             side=8
        #             x,y=5,15
        #             type=Dwarvish Guardsman
        #             random_traits=no
        #             [modifications]
        #                 {TRAIT_STILL}
        #                 {OBJECT_20_HP}
        #             [/modifications]
        #         [/unit]

        # Initial AI units - Side 4
        #                 {ANL_PLACE_UNIT 4 "Goblin Spearman" 2 15}
        #                 {ANL_PLACE_UNIT 4 "Goblin Spearman" 2 15}
        #                 {ANL_PLACE_UNIT 4 "Goblin Spearman" 2 15}

        [unit]
            side=8 # Was on side 3.
            type=Dwarvish Guardsman
            generate_name=yes
            ai_special=guardian
            random_traits=no
            role=guardian
            max_moves=0 ## this will remove all movements..
            x,y=37,12
            [modifications]
                {MOVEMENT_RESTRICTION_FULL}
            [/modifications]
        [/unit]

        [unit]
            side=8 # Was on side 6.
            type=Dwarvish Guardsman
            generate_name=yes
            ai_special=guardian
            random_traits=no
            role=guardian
            max_moves=0 ## this will remove all movements..
            x,y=5,15
            [modifications]
                {MOVEMENT_RESTRICTION_FULL}
            [/modifications]
        [/unit]
    [/event]

    # ------------------------------------------------------
    # Items
    # ------------------------------------------------------

    # Store locations of treasure:

    [event]
        name=prestart
        [store_locations]
            x=19,23,3,39
            y=14,14,13,9
            variable=locations_for_items
        [/store_locations]

        # Place treasure and druids.
        [foreach]
            array=locations_for_items
            [do]
                #for every item
                {VARIABLE x $this_item.x}
                {VARIABLE y $this_item.y}

                [item]
                    x,y=$x,$y
                    image=items/chest-plain-closed.png
                [/item]

                #  {PICKUPPABLE_ITEM ring_of_hp 23 14 race=human items/ring-red.png
                #      _"$unit.name finds a pretty ring. Should he pick it up?"
                #      _"ring of HP^Take it"
                #      _"ring of HP^Leave it"
                #      _"$unit.name finds a pretty ring. But only a human can take it!" (
                #      [object]
                #          name= _ "Ring of HP"
                #          image=items/ring-red.png
                #          description= _ "This ring grants the wearer +10 max hp!"
                #
                #          [effect]
                #              apply_to=hitpoints
                #              increase_total=10
                #          [/effect]
                #      [/object]
                #  )}

                # Add event where a player grabs the treasure.
                [event]
                    name=moveto
                    first_time_only=yes
                    # Substitute $x and $y now, not later.
                    delayed_variable_substitution=no
                    # Use id= to remove event.at turn 13
                    id="aybabtu druid treasure $x $y"
                    [filter]
                        x,y=$x,$y
                        side=1,2
                    [/filter]
                    [fire_event]
                        #use name to name the next event
                        name=aybabtu druid treasure
                        [primary_unit]
                            x,y=$x,$y
                        [/primary_unit]
                    [/fire_event]
                    [remove_item]
                        image="items/chest-plain-closed.png"
                        x,y=$x,$y
                    [/remove_item]
                [/event]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE x,y,locations_for_items}
    [/event]

    [event]
        name=aybabtu druid treasure
        first_time_only=no

        [message]
            speaker=narrator
            message= _ "You found druid items, but you can take only one."

            [option]
                description="<span color='green'>" + _ "Increase worker HP" + "</span>
" + _ "Increases all worker’s hitpoints by 20%"
                image=icons/dress_silk_green.png
                [command]
                    [modify_unit]
                        [filter]
                            side=$side_number
                            type=Goblin Spearman,Goblin Impaler,Goblin Rouser,Peasant,Ruffian,Woodsman,ANLEra Dwarvish Miner,Dwarvish Miner,ANLEra Elvish Civilian,ANLEra Drake Worker,ANLEra Young Saurian,ANLEra Dune Civilian,Walking Corpse,Soulless,Merman Citizen,ANLEra Merman Citizen
                        [/filter]
                        [object]
                            [effect]
                                apply_to=hitpoints
                                increase_total=20%
                                increase=20%
                            [/effect]
                        [/object]
                    [/modify_unit]

                    [event]
                        name=prerecruit
                        first_time_only=no

                        delayed_variable_substitution=no
                        # Substitute $side_number now, not later.
                        [filter]
                            side=$side_number
                            type=Goblin Spearman,Goblin Impaler,Goblin Rouser,Peasant,Ruffian,Woodsman,ANLEra Dwarvish Miner,Dwarvish Miner,ANLEra Elvish Civilian,ANLEra Drake Worker,ANLEra Young Saurian,ANLEra Dune Civilian,Walking Corpse,Soulless,Merman Citizen,ANLEra Merman Citizen
                        [/filter]
                        [modify_unit]
                            [filter]
                                # This variable is substituted later.
                                # $| escapes the $, that's why it is not substituted now.
                                id=$|unit.id
                            [/filter]
                            [object]
                                [effect]
                                    apply_to=hitpoints
                                    increase_total=20%
                                    increase=20%
                                [/effect]
                            [/object]
                        [/modify_unit]
                    [/event]
                [/command]
            [/option]

            [option]
                description="<span color='green'>" + _ "Take glowing staff" + "</span>
" + _ "Provides 25-2 melee impact magical attack"
                image=attacks/staff-elven.png
                [show_if]
                    [not]
                        [have_unit]
                            x,y=$x1,$y1
                            [has_attack]
                                name=glowing staff
                            [/has_attack]
                        [/have_unit]
                    [/not]
                [/show_if]
                [command]
                    [object]
                        silent=yes
                        duration=forever
                        [effect]
                            apply_to=new_attack
                            name= _ "glowing staff"
                            icon=attacks/staff-elven.png
                            type=impact
                            range=melee
                            [specials]
                                {WEAPON_SPECIAL_MAGICAL}
                            [/specials]
                            damage=25
                            number=2
                        [/effect]
                    [/object]
                [/command]
            [/option]

            [option]
                description="<span color='green'>" + _ "Take sparkling wand" + "</span>
" + _ "Provides 25-2 ranged fire magical attack"
                image=attacks/staff-elven-star.png
                [show_if]
                    [not]
                        [have_unit]
                            x,y=$x1,$y1
                            [has_attack]
                                name=sparkling wand
                            [/has_attack]
                        [/have_unit]
                    [/not]
                [/show_if]
                [command]
                    [object]
                        silent=yes
                        duration=forever
                        [effect]
                            apply_to=new_attack
                            name= _ "sparkling wand"
                            icon=attacks/staff-elven-star.png
                            type=fire
                            range=ranged
                            [specials]
                                {WEAPON_SPECIAL_MAGICAL}
                            [/specials]
                            damage=25
                            number=2
                        [/effect]
                    [/object]
                [/command]
            [/option]
        [/message]
    [/event]

    # ------------------------------------------------------
    # Messages
    # ------------------------------------------------------

    # Copied from 2p A New Island map.
    [event]
        name=side 1 turn, side 2 turn
        [filter_condition]
            [have_unit]
                side=$side_number
                type_adv_tree=Mermaid Initiate
            [/have_unit]
            [variable]
                name=turn_number
                numerical_not_equals=25
            [/variable]
        [/filter_condition]

        [if]
            [have_unit]
                side=$side_number
                type=ANLEra Merman Citizen,Merman Citizen
            [/have_unit]
            [then]
                [store_unit]
                    [filter]
                        side=$side_number
                        type=ANLEra Merman Citizen,Merman Citizen
                    [/filter]
                    variable=builder
                [/store_unit]
                [message]
                    side_for=$side_number
                    id=$builder.id
                    caption="$builder.language_name" # wmllint: noconvert
                    message= _ "I can build not only castles and villages, but also a Merfolk university. Merfolk researchers can study there."
                [/message]
                {CLEAR_VARIABLE builder}
            [/then]
            [else]
                [message]
                    type_adv_tree=Mermaid Initiate
                    side=$side_number
                    side_for=$side_number
                    message= _ "I can fight skeletons – or devote my time to studies in a Merfolk university." + "
" + _ "Merfolk units of level 0 can build villages and universities in the water and at the shore."
                [/message]
            [/else]
        [/if]
    [/event]

    # ------------------------------------------------------
    # AI Recruitment Pattern
    # ------------------------------------------------------

    [event]
        name=turn 7

        [allow_recruit]
            side=3,5
            type=Soulless
        [/allow_recruit]

        [allow_recruit]
            side=4,6
            type=Goblin Rouser
        [/allow_recruit]
    [/event]

    [event]
        name=turn 9

        [allow_recruit]
            side=3,5
            type=Skeleton
        [/allow_recruit]

        [allow_recruit]
            side=4,6
            type=Orcish Grunt
        [/allow_recruit]
    [/event]

    [event]
        name=turn 11

        [allow_recruit]
            side=3,5
            type=Skeleton Archer
        [/allow_recruit]

        [allow_recruit]
            side=4,6
            type=Orcish Archer
        [/allow_recruit]
    [/event]

    [event]
        name=turn 11
        #ADDED
        #what is disallow recruit

        [disallow_recruit]
            side=3,5
            type=Walking Corpse,Soulless
        [/disallow_recruit]

        [disallow_recruit]
            side=4,6
            type=Goblin Spearman,Goblin Rouser
        [/disallow_recruit]
    [/event]

    [event]
        name=turn 15
        # Extra gold bonus compared to other maps.
        [gold]
            side=3,4,5,6
            amount=30
        [/gold]

        [allow_recruit]
            side=3,5
            type=Dark Adept
        [/allow_recruit]

        [allow_recruit]
            side=4,6
            type=Orcish Assassin
        [/allow_recruit]
    [/event]

    [event]
        name=turn 18
        # One turn later than on other maps.

        [gold]
            side=3,4,5,6
            amount=50
        [/gold]

        [allow_recruit]
            side=3,5
            type=Necrophage,Bone Shooter,Revenant
        [/allow_recruit]

        #         [allow_recruit]
        #             side=5
        #             type=Longbowman,Shock Trooper,Pikeman
        #         [/allow_recruit]

        [allow_recruit]
            side=4,6
            type=Troll,Orcish Crossbowman,Orcish Warrior
        [/allow_recruit]

        # Income boost, because L2 units are more expensive.
        [store_side]
            side=3,4,5,6
            variable=ai_sides
        [/store_side]
        [foreach]
            array=ai_sides
            variable=this_side
            [do]
                [modify_side]
                    side=$this_side.side
                    # Is actually an +5 increase.
                    income="$($this_side.base_income + 3)"
                [/modify_side]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE ai_sides}
    [/event]

    [event]
        name=turn 20
        # Reinforcements.

        [gold]
            side=3,4,5,6
            amount=25
        [/gold]
    [/event]

    [event]
        name=turn 25

        {RECORD_GAME_AS_WON}
    [/event]

    # Copied form 5p map
    [event]
        name=turn 26

        [gold]
            side=3,4,5,6
            amount=50
        [/gold]

        [allow_recruit]
            side=4,6
            type=Great Troll,Troll Warrior
        [/allow_recruit]

        [allow_recruit]
            side=3,5
            type=Ghost,Ghast
        [/allow_recruit]
    [/event]

    # Copied form 5p map
    [event]
        name=turn 34

        [gold]
            side=4,6
            amount=70
        [/gold]

        [allow_recruit]
            side=4,6
            type=Goblin Knight,Goblin Pillager
        [/allow_recruit]

        [allow_recruit]
            side=3,5
            type=Wraith
        [/allow_recruit]

        [event]
            name=new turn
            [filter_condition]
                [lua]
                    name="timecheck"
                    code="return wesnoth.schedule.get_time_of_day(nil).id == 'afternoon'"
                [/lua]
            [/filter_condition]

            [gold]
                side=3,5
                amount=70
            [/gold]

            [allow_recruit]
                side=3,5
                type=Shadow
            [/allow_recruit]
        [/event]
    [/event]

    # For extreme long games
    [event]
        name=turn 120

        [disallow_recruit]
            side=4,6
            type=Goblin Knight
        [/disallow_recruit]

        [allow_recruit]
            side=4
            type=Orcish Slurbow,Naga Sicarius
        [/allow_recruit]

        [allow_recruit]
            side=6
            type=Orcish Slurbow,Direwolf Rider
        [/allow_recruit]

        [allow_recruit]
            side=3,5
            type=Spectre,Deathblade,Banebow,Chocobone,Lich
        [/allow_recruit]
    [/event]

    # Like on 4p map +1g every 4 turns.
    [event]
        name=turn 15

        # increase each turn one enemy's income by 1
        [event]
            name=new turn
            first_time_only=no

            [store_side]
                side="$($turn_number % 4 + 3)"
                variable=side
            [/store_side]
            # [store_side]base_income is the income without villages and upkeep.
            # [modify_side]income is the value from the WML file, always 2 less.
            # thus -1 instead of +1 to increase by 1
            [modify_side]
                side="$($turn_number % 4 + 3)"
                income="$($side.base_income-1)"
            [/modify_side]
            {CLEAR_VARIABLE side}
        [/event]
    [/event]
[/multiplayer]
