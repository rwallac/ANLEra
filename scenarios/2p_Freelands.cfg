#textdomain wesnoth-ANLEra

# Created by Hay207, from ANL 2p add-on on 1.12 server.
# Coding help from Goddzillla.
#
# Plays on the map from The Freelands.

# Note:
# This file can use the ANLEra macros or the mainline ANL macros,
# it will use the ones which are defined.
# (PLACE_CHEST macro is defined in The Great Wall)
#
# This is so that one can place the file also into an own add-on outside of ANLEra.

[multiplayer]
    id=ANLEra_Freelands
    name= _ "2p â€” A New Freeland"
    map_file=2p_ANL_Freelands.map
    # wmllint: local spellings PvP PvP-Mode ANL [tunnel] Freelands.
    description= _ "This survival scenario can be played as PvP when not using map settings.

You can play PvP versus the AI.
Or you can also be allied with an AI side each.
Even playing the AI sides is possible.

And of cause you can play together versus the AI."

    experience_modifier=70%
    allow_era=ANLEra,JoyCamp

    {DEFAULT_SCHEDULE}
    {DEFAULT_MUSIC_PLAYLIST}

    # ------------------------------------------------------
    # Include and define ANL macros
    # ------------------------------------------------------
#ifdef ENABLE_TRAPPED_CREATURES
    {ENABLE_TRAPPED_CREATURES}
#endif

#define TEAMCHECK
    [lua]
        name="teamcheck"
        code="return not wesnoth.sides.is_enemy(1,2)"
    [/lua]
#enddef

#define CUSTOM_UNIT_CHECK
    [lua]
        name="unitcheck"
        code="return wesnoth.scenario.era.id == 'ANLEra'"
    [/lua]
#enddef

    # To include macros from  mainline, in case this file is not in the ANLEra add-on.
    # {multiplayer/scenarios/ANL_utils/}

    # ------------------------------------------------------
    # Teleport bidirectional and Chest
    # ------------------------------------------------------

    [event]
        name=prestart

        [if]
            {TEAMCHECK}
            [then]
                [tunnel]
                    [filter]
                        # If the tunnel is blocked, AI sides would still gather units at the tunnel entrance.
                        # It is now only enabled for player sides.
                        side=1,2
                    [/filter]
                    [source]
                        x=23
                        y=4
                    [/source]
                    [target]
                        x=15
                        y=21
                    [/target]
                    bidirectional=yes
                [/tunnel]

                {PLACE_IMAGE "scenery/rune2-glow.png" 23 4}
                {PLACE_IMAGE "scenery/rune2-glow.png" 15 21}

                # CHEST
                {PLACE_CHEST 19 12 (side="1,2") 20}
            [/then]
        [/if]
    [/event]

    # ------------------------------------------------------
    # Story & Objectives
    # ------------------------------------------------------

    [story]
        [part]
            show_title=yes
            story= _ "You enter The Freelands. What can you find here? You plan to settle here too, but you are not alone here."
        [/part]
    [/story]

    [event]
        name=prestart

        [objectives]
            side=1,2,5
            bullet=""
            victory_string=""
            defeat_string=""
            summary="<small>" + _ "Right-click on a leader for help" + "</small>" # wmllint: no spellcheck

            # Special objective to warn the other player.
            [objective]
                description= _ "You play in PvP-Mode

"
                condition=win
                # RGB for color "violet" from Pango.
                red,green,blue=238,130,238
                [show_if]
                    [not]
                        {TEAMCHECK}
                    [/not]
                [/show_if]
            [/objective]

            # Normal objective.
            [objective]
                description= _ "You must survive until turn 25

"
                #  If a standard string includes whitespaces, it must be enclosed within double quotes.
                condition=win
                [show_if]
                    {TEAMCHECK}
                [/show_if]
            [/objective]

            # Additional text.
            [objective]
                description= _ "Spiders and cave village income are present"
                condition=win
            [/objective]
            #
            [objective]
                description= _ "A tunnel connects you to the other side"
                condition=win
                [show_if]
                    {TEAMCHECK}
                [/show_if]
            [/objective]
            [objective]
                description= _ "There are multiple ways to play this scenario"
                condition=win
            [/objective]

            note= _ "From Hay207's ANL 2P"
        [/objectives]

        # If players change the controller of the AI sides and play them themselves.
        [objectives]
            side=3,4
            [objective]
                #textdomain wesnoth
                description= _ "Defeat enemy leader(s)"
                condition=win
                #textdomain wesnoth-ANLEra
            [/objective]

            [note]
                description= _ "You get some recalls in turn 15."
                [show_if]
                    {CUSTOM_UNIT_CHECK}
                [/show_if]
            [/note]

            [note]
                description= _ "You cannot use the [tunnel]"
                [show_if]
                    {TEAMCHECK}
                [/show_if]
            [/note]
        [/objectives]
    [/event]

    # ------------------------------------------------------
    # Side Definitions
    # ------------------------------------------------------

    # Players

    [side]
        side=1
        controller=human
        team_name=players
        user_team_name= _ "teamname^Newcomers"
        team_lock=yes
        income_lock=no
        village_gold=2
        gold=75
        shroud=no
        fog=yes
        [ai]
            aggression=0.2
            caution=0.8
            grouping=defensive
            support_villages=yes
            allow_ally_villages=yes
            [avoid]
                [filter]
                    side=3
                [/filter]
                x=12
                y=7
                radius=1
            [/avoid]
            [goal]
                name=target_location
                [criteria]
                    x=5
                    y=5
                    terrain=*^V*
                    [filter][/filter]
                [/criteria]
                value=2
            [/goal]
        [/ai]
    [/side]

    [side]
        side=2
        controller=human
        team_name=players
        user_team_name= _ "teamname^Newcomers"
        team_lock=yes
        village_gold=2
        gold=75
        shroud=no
        fog=yes
        [ai]
            aggression=0.2
            caution=0.8
            grouping=defensive
            support_villages=yes
            allow_ally_villages=yes
            [avoid]
                [filter]
                    side=4
                [/filter]
                x=26
                y=17
                radius=1
            [/avoid]
            [goal]
                name=target_location
                [criteria]
                    x=33
                    y=20
                    terrain=*^V*
                    [filter][/filter]
                [/criteria]
                value=2
            [/goal]
        [/ai]
    [/side]

    # AI sides

    [side]
        side=3
        controller=ai
        # Workaround:
        allow_player=yes
        disallow_observers=yes
        team_name=inhabitants
        #textdomain wesnoth-anl
        user_team_name= _ "teamname^Enemies"
        controller_lock=yes
        gold=25
        recruit=Walking Corpse
        income=16
        village_gold=2
        team_lock=yes
        income_lock=no
        faction=Custom
        faction_lock=yes
        type=Death Knight
        name=""
        [modifications]
            {MOVEMENT_RESTRICTION}
        [/modifications]
        [ai]
            aggression=1.0
            allow_ally_villages=yes
            recruitment_more="Troll,Orcish Crossbowman,Orcish Warrior"
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 3 main_loop retreat_injured}
            [goal]
                name=protect_location
                [criteria]
                    x=5
                    y=5
                    terrain=*^V*
                [/criteria]
                protect_radius=4
                value=3
            [/goal]
        [/ai]
        [village]
            x,y=5,5
        [/village]
    [/side]

    [side]
        side=4
        controller=ai
        # Workaround:
        allow_player=yes
        disallow_observers=yes
        team_name=inhabitants
        user_team_name= _ "teamname^Enemies"
        controller_lock=yes
        gold=25
        recruit=Goblin Spearman
        # 16 +2 income = 2 goblin recruits
        income=16
        village_gold=2
        team_lock=yes
        income_lock=no
        faction=Custom
        faction_lock=yes
        type=Orcish Sovereign
        # To not name it Computer 4.
        name=""
        [modifications]
            {MOVEMENT_RESTRICTION}
        [/modifications]
        [ai]
            aggression=1.0
            allow_ally_villages=yes
            recruitment_more="2"
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 4 main_loop retreat_injured}
            [goal]
                name=protect_location
                [criteria]
                    x=33
                    y=20
                    terrain=*^V*
                [/criteria]
                protect_radius=4
                value=3
            [/goal]
        [/ai]
        [village]
            x,y=33,20
        [/village]
    [/side]

    # ------------------------------------------------------

    # This side is for trapped units. It is allied to the AI so they don't attack it.

    [side]
        side=5
        color=teal
        controller=null
        allow_player=no
        disallow_observers=yes
        no_leader=yes
        leader_lock=yes
        hidden=yes
        share_vision=none
        team_name=inhabitants
        user_team_name= _ "teamname^Enemies"
        #textdomain wesnoth-ANLEra
        controller_lock=yes
        gold=0
        income=2
        village_gold=0
        village_support=0
        team_lock=yes
        gold_lock=yes
        income_lock=yes
        faction=Custom
        faction_lock=yes
        [ai]
            ai_algorithm=idle_ai
        [/ai]
    [/side]

    # Important workaround.
    # If the ai sides have allow_player=no, and map settings are not used,
    # then they will be in team 2, even when a player chooses team 2.
    #
    # Because of that, they have allow_player=yes
    # That might be useful anyway, allowing each player to be allied with one ai in PvP mode.
    #
    # However, side 5 needs to be allied to both of the ai sides.
    # With use map settings off, a side can not be in multiple teams.
    # Fixing this here.
    [event]
        name=prestart

        [lua]
            name="teamcorrection"
            code="
if wesnoth.sides[3].team_name == wesnoth.sides[4].team_name then
    wesnoth.sides[5].team_name = wesnoth.sides[3].team_name
    wesnoth.sides[5].user_team_name = wesnoth.sides[3].user_team_name
else
    wesnoth.sides[5].team_name = wesnoth.sides[3].team_name ..','.. wesnoth.sides[4].team_name
    wesnoth.sides[5].user_team_name = wesnoth.textdomain 'wesnoth-anl' 'teamname^Prisoners'
end

if not wesnoth.sides.is_enemy(3,1) or not wesnoth.sides.is_enemy(3,2) then
    wesnoth.sides[3].share_vision = 'none'
end

if not wesnoth.sides.is_enemy(4,1) or not wesnoth.sides.is_enemy(4,2) then
    wesnoth.sides[4].share_vision = 'none'
end
"
        [/lua]
    [/event]

    # There is a bug that user_team_name is not changed when having team_lock=no and not using map settings.
    # Thus it is set to team_lock=yes

    # ------------------------------------------------------
    # Scenario Events
    # ------------------------------------------------------

    # Rescuing trapped units.

#ifdef ANL_RESCUE_TRAPPED_UNIT
    {ANL_RESCUE_TRAPPED_UNIT 31 2 31 1 ()}
    {ANL_RESCUE_TRAPPED_UNIT 9 23 9 24 ()}
#endif

    # Placing units.
    [event]
        name=prestart

        # Placing spiders
        #  4 is hitpoints amount
        {ANL_PLACE_WOUNDED_UNIT 3 "Giant Spider" 33 4 4}
        {ANL_PLACE_WOUNDED_UNIT 4 "Giant Spider" 6 21 4}

        # Placing trapped creatures
#ifdef ANL_PLACE_TRAPPED_UNIT
        {ANL_PLACE_TRAPPED_UNIT 5 "Fire Drake" 31 1}
        {ANL_PLACE_TRAPPED_UNIT 5 "Elder Wose" 9 24}
#else
        {TRAPPED_CREATURE_WEB  31 1 "Fire Drake" 5 1,2}
        {TRAPPED_CREATURE_WOSE 9 24 "Elder Wose" 5 1,2}
#endif

        # Initial AI units - Side 3 - corpse at mine and other guard
        {ANL_PLACE_GUARD_L0 3 "Walking Corpse" 5 5} {GUARDIAN}
        [random_placement]
            [filter_location]
                [and]
                    x,y=5,5
                    radius=1
                [/and]
                [not]
                    x,y=5,5
                [/not]
            [/filter_location]
            num_items=3
            min_distance=0
            variable=pos
            [command]
                {NOTRAIT_UNIT 3 "Walking Corpse" $pos.x $pos.y} {GUARDIAN}
            [/command]
        [/random_placement]

        {ANL_PLACE_GUARDIAN 3 "Banebow" 12 7}
        {ANL_PLACE_GUARDIAN 3 "Banebow" 8 14}

        # Initial AI units - Side 4
        {NOTRAIT_UNIT 4 "Goblin Spearman" 34 19} {GUARDIAN}
        {NOTRAIT_UNIT 4 "Goblin Spearman" 33 19} {GUARDIAN}
        {NOTRAIT_UNIT 4 "Goblin Spearman" 33 21} {GUARDIAN}
        {NOTRAIT_UNIT 4 "Goblin Spearman" 33 20}
        [+unit]
            id=mushroomer
        [/unit]
        [micro_ai]
            side=4
            ai_type=return_guardian
            action=add
            ca_id=mushroomguard

            [filter]
                id=mushroomer
                [filter_location]
                    x,y=33,20
                    radius=10
                [/filter_location]
            [/filter]
            return_x,return_y=33,20
        [/micro_ai]

        {ANL_PLACE_GUARDIAN 4 "Orcish Slurbow" 30 10}
        {ANL_PLACE_GUARDIAN 4 "Orcish Slurbow" 26 17}
        #        {ANL_PLACE_GUARDIAN 6 "Orcish Warrior" 21 11}
    [/event]

    # Short delay and protection of early game mushroom mine rush.
    [event]
        name=side 3 turn

        [event]
            name=unit placed
            first_time_only=yes
            [filter]
                side=3
                level=0
            [/filter]

            [micro_ai]
                side=3
                ai_type=goto
                action=add
                ca_score=95000
                release_unit_at_goal=yes

                [filter]
                    id=$unit.id
                [/filter]
                [filter_location]
                    x,y=5,5
                    radius=1
                [/filter_location]
            [/micro_ai]
        [/event]

        # {UNIT 3 "Walking Corpse" 13 11 moves=0}

    [/event]

    [event]
        name=side 4 turn

        [event]
            name=unit placed
            first_time_only=yes
            [filter]
                side=4
                level=0
            [/filter]

            [micro_ai]
                side=4
                ai_type=goto
                action=add
                ca_score=95000
                release_unit_at_goal=yes

                [filter]
                    id=$unit.id
                [/filter]
                [filter_location]
                    x,y=33,20
                    radius=1
                [/filter_location]
            [/micro_ai]
        [/event]

        # {UNIT 4 "Goblin Spearman" 25 13 moves=0}

    [/event]


    # Destroying mushroom mines
    [event]
        name=moveto
        [filter]
            x,y=5,5
            side=1,2
        [/filter]
        [filter_condition]
            [have_unit]
                canrecruit=yes
                side=3
            [/have_unit]
        [/filter_condition]

        [lua]
            name="mushroom3"
            code="wesnoth.sides[3].base_income = wesnoth.sides[3].base_income -10"
        [/lua]

        {MODIFY_TERRAIN Uh $x1 $y1}
        [redraw][/redraw]
        [sound]
            name=skeleton-die-1.ogg
        [/sound]
        [message]
            speaker=narrator
            image=terrain/village/cave-tile.png
            message= _ "The mushroom mine was destroyed. Side 3 now has 10 less base income."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            x,y=33,20
            side=1,2
        [/filter]
        [filter_condition]
            [have_unit]
                canrecruit=yes
                side=4
            [/have_unit]
        [/filter_condition]

        [lua]
            name="mushroom4"
            code="wesnoth.sides[4].base_income = wesnoth.sides[4].base_income -10"
        [/lua]

        {MODIFY_TERRAIN Uh $x1 $y1}
        [redraw][/redraw]
        [sound]
            name=skeleton-die-1.ogg
        [/sound]
        [message]
            speaker=narrator
            image=terrain/village/cave-tile.png
            message= _ "The mushroom mine was destroyed. Side 4 now has 10 less base income."
        [/message]

        [micro_ai]
            side=4
            ai_type=return_guardian
            action=delete
            ca_id=mushroomguard
        [/micro_ai]
    [/event]

    # Deaths

    [event]
        name=last breath
        [filter]
            canrecruit=yes
            side=1
        [/filter]

        [message]
            speaker=unit
            #textdomain wesnoth-anl
            message= _ "I have fallen, but all is not lost!"
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            canrecruit=yes
            side=2
        [/filter]

        [message]
            speaker=unit
            message= _ "I am done for, but we have yet to lose this battle!"
            #textdomain wesnoth-ANLEra
        [/message]
    [/event]

    # ------------------------------------------------------
    # AI Recruitment Pattern
    # ------------------------------------------------------

    [event]
        name=turn 7

        [allow_recruit]
            side=3
            type=Soulless
        [/allow_recruit]

        [allow_recruit]
            side=4
            type=Goblin Rouser
        [/allow_recruit]
    [/event]

    [event]
        name=turn 9

        [gold]
            side=3,4
            amount=25
        [/gold]

        [allow_recruit]
            side=3
            type=Skeleton
        [/allow_recruit]

        [allow_recruit]
            side=4
            type=Orcish Grunt
        [/allow_recruit]
    [/event]

    [event]
        name=turn 11

        [gold]
            side=3,4
            amount=25
        [/gold]

        [allow_recruit]
            side=3
            type=Skeleton Archer
        [/allow_recruit]

        [allow_recruit]
            side=4
            type=Orcish Archer
        [/allow_recruit]
    [/event]

    [event]
        name=turn 11
        #ADDED

        [disallow_recruit]
            side=3
            type=Walking Corpse,Soulless
        [/disallow_recruit]

        [disallow_recruit]
            side=4
            type=Goblin Spearman,Goblin Rouser
        [/disallow_recruit]
    [/event]

    [event]
        name=turn 15

        [gold]
            side=3,4
            amount=44
        [/gold]

        [allow_recruit]
            side=3
            type=Dark Adept
        [/allow_recruit]

        [allow_recruit]
            side=4
            type=Orcish Assassin
        [/allow_recruit]

        # Side 3 can now recruit research units. Side 4 can recall them.
        # Ai won't recall the units because they are +1 gold more expensive than their gold value.
        # Though if sth. changes and the AI would do that, it's not bad either.

        [if]
            {CUSTOM_UNIT_CHECK}
            [then]
                [unit]
                    side=4
                    type=ANLEra Novice Orcish Shaman
                    random_gender=yes
                    recall_cost=19
                    x,y=recall,recall
                [/unit]
                [unit]
                    side=4
                    type=ANLEra Novice Orcish Shaman
                    random_gender=yes
                    recall_cost=19
                    x,y=recall,recall
                [/unit]
                [unit]
                    side=4
                    type=ANLEra Novice Orcish Shaman
                    random_gender=yes
                    recall_cost=19
                    x,y=recall,recall
                [/unit]
                [unit]
                    side=4
                    type=Goblin Rouser
                    random_traits=no
                    recall_cost=14
                    x,y=recall,recall
                [/unit]
                [unit]
                    side=4
                    type=Goblin Impaler
                    random_traits=no
                    recall_cost=14
                    x,y=recall,recall
                [/unit]

                [unit]
                    side=3
                    type=Skeleton Rider
                    recall_cost=18
                    x,y=recall,recall
                [/unit]
                [unit]
                    side=3
                    type=Skeleton Rider
                    recall_cost=18
                    x,y=recall,recall
                [/unit]
                [unit]
                    side=3
                    type=Skeleton Rider
                    recall_cost=18
                    x,y=recall,recall
                [/unit]
                [unit]
                    side=3
                    type=Soulless
                    variation=beast_rider
                    recall_cost=14
                    x,y=recall,recall
                [/unit]
                [unit]
                    side=3
                    type=Soulless
                    variation=mounted
                    recall_cost=14
                    x,y=recall,recall
                [/unit]
            [/then]
        [/if]

        # Income boost, because L2 units will be more expensive.
        [store_side]
            side=3,4
            [has_unit]
                canrecruit=yes
            [/has_unit]
            variable=ai_sides
        [/store_side]
        [foreach]
            array=ai_sides
            variable=this_side
            [do]
                [modify_side]
                    side=$this_side.side
                    # Is actually an +6 increase, not only +4.
                    income="$($this_side.base_income + 4)"
                [/modify_side]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE ai_sides}
    [/event]

    [event]
        name=turn 17

        [gold]
            side=3,4
            amount=45
        [/gold]

        [allow_recruit]
            side=3
            type=Necrophage,Bone Shooter,Revenant
        [/allow_recruit]

        [allow_recruit]
            side=4
            type=Troll,Orcish Crossbowman,Orcish Warrior
        [/allow_recruit]
    [/event]

    [event]
        name=turn 25

        # Once more changing income.
        [store_side]
            side=3,4
            [has_unit]
                canrecruit=yes
            [/has_unit]
            variable=ai_sides
        [/store_side]
        [foreach]
            array=ai_sides
            variable=this_side
            [do]
                [modify_side]
                    side=$this_side.side
                    # It is an +4 increase.
                    income="$($this_side.base_income + 2)"
                [/modify_side]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE ai_sides}

#ifdef RECORD_GAME_AS_WON
        {RECORD_GAME_AS_WON}
#endif

        # Because the AI side has allow_player=yes, adding the worker units back.
        [allow_recruit]
            side=3
            type=Soulless
        [/allow_recruit]
        [allow_recruit]
            side=4
            type=Goblin Impaler
        [/allow_recruit]

        [if]
            {CUSTOM_UNIT_CHECK}
            [then]
                [allow_recruit]
                    side=4
                    type=ANLEra Orcish Shaman
                [/allow_recruit]
            [/then]
        [/if]
    [/event]
[/multiplayer]

#undef TEAMCHECK
#undef CUSTOM_UNIT_CHECK
