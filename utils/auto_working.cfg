#textdomain wesnoth-ANLEra

# ------------------------------------------------------
# Automatic Studying
# ------------------------------------------------------

#define AUTO_DIPLOMACY
    [store_unit]
        [filter]
            side=$side_number
            canrecruit=yes # Only leader can do diplomacy
            [not]
                status=worked_this_turn
            [/not]
            [filter_location]
                terrain={ANL_UNIVERSITIES}
            [/filter_location]
        [/filter]

        variable=diplomatist
    [/store_unit]

    [foreach]
        array=diplomatist
        [do]
            # Player forgot to negotiate.
            # Give him 1 point to a random negotiation option.
            # It is probably not the one he wanted, but it is for free.
            #
            # Leader options are currently 1-9, variable naming is
            # wml.variables['player_1.leader_option_9.progress']
            #
            # Not giving him the last point, to not show the unit selection dialogue.
            [lua]
                name="auto diplomacy"
                code=<<
local leader_options = {}
local p = wesnoth.current.side

if wesnoth.scenario.id == 'Undead_Empire' then
    local drakes = wml.variables['player_'..p..'.leader_option_3']
    if drakes.progress < drakes.target -1 then
        wml.variables['player_'..p..'.leader_option_3.progress'] = drakes.progress + 1
    end
else

    for i = 1, 9 do
        local negotiation = wml.variables['player_'..p..'.leader_option_'..i]
        if negotiation.progress < negotiation.target -1 then

            if i ~= 6 then
                -- Leader option 6 (Outlaws) is currently disabled in diplomacy.lua
                table.insert(leader_options, 'leader_option_'..i)
            end
        end
    end

    if #leader_options > 0 then
        local l = mathx.random_choice(leader_options)
        wml.variables['player_'..p..'.'..l..'.progress'] = wml.variables['player_'..p..'.'..l..'.progress'] + 1
    end

end
>>
            [/lua]

            {VARIABLE sound yes}

            [floating_text]
                x,y=$this_item.x,$this_item.y
                text="<span color='#117c17'>1</span>" # wmllint: noconvert
            [/floating_text]
        [/do]
    [/foreach]

    [if]
        {VARIABLE_CONDITIONAL sound boolean_equals yes}
        [then]
            [sound]
                name=magic-holy-miss-3.ogg
            [/sound]
        [/then]
    [/if]

    {CLEAR_VARIABLE diplomatist}
#enddef

#define AUTO_STUDYING TYPES
    [store_unit]
        [filter]
            type_adv_tree={TYPES}
            side=$side_number
            canrecruit=no
            [filter_location]
                terrain={ANL_UNIVERSITIES}
            [/filter_location]
            [or]
                type_adv_tree="Mermaid Initiate"
                side=$side_number
                canrecruit=no
                [filter_location]
                    terrain="Sm^Vm"
                [/filter_location]
            [/or]
        [/filter]

        variable=researchers
    [/store_unit]

    [foreach]
        array=researchers
        [do]
            {ADDING_TO_CURRENT_RESEARCH_FIELD "$($this_item.level + $player_$side_number|.philosophy.bonus?0|)" }

            {VARIABLE sound yes}

            [scroll_to]
                x,y=$this_item.x,$this_item.y
                [filter_side]
                    side=$this_item.side
                [/filter_side]
            [/scroll_to]

            [floating_text]
                x,y=$this_item.x,$this_item.y
                text="<span color='#ffffff'>$($this_item.level + $player_$side_number|.philosophy.bonus?0|)</span>" # wmllint: noconvert
            [/floating_text]
        [/do]
    [/foreach]

    [if]
        {VARIABLE_CONDITIONAL sound boolean_equals yes}
        [then]
            [sound]
                name=magic-holy-miss-3.ogg
            [/sound]

            [delay]
                time=200
            [/delay]
        [/then]
    [/if]

    {CLEAR_VARIABLE sound,researchers}
#enddef

# ------------------------------------------------------
# Automatic Farming
# ------------------------------------------------------

#define AUTO_FARMING TYPES
    [store_unit]
        [filter]
            type={TYPES}
            side=$side_number
            [filter_location]
                terrain=*^Gvs
            [/filter_location]
        [/filter]
        variable=harvesters
    [/store_unit]

    [store_unit]
        [filter]
            type={TYPES}
            side=$side_number
            [filter_location]
                terrain=Re
            [/filter_location]
        [/filter]
        variable=planters
    [/store_unit]

    [foreach]
        array=harvesters
        [do]
            # Set the base earnings
            {VARIABLE temp_gold "$player_$side_number|.farming.gold"}
            # If the farmer is not adjecent to a village: -1 gold
            [if]
                [have_location]
                    x,y=$this_item.x,$this_item.y
                    #terrain=Re^Gvs # already filtered for harvesters list
                    [filter_adjacent_location]
                        #terrain="!,K*^*,!,*^Vd*,*^Vct,*^Vo*,*^Vd*,*^Vu*,*^Vl*,*^Vc*,*^Vht,*^Vh,*^Vhr,*^Vhcr,*^Ve*"
                        terrain=*^V*
                    [/filter_adjacent_location]
                [/have_location]
                [else]
                    {VARIABLE_OP temp_gold add -1}
                [/else]
            [/if]

            {MODIFY_TERRAIN "Re" $this_item.x $this_item.y}
            # Remove straw bale icon.
            # In case there is also another item such as a flaming sword, it won't be removed.
            # (Only possible in combination with other add-ons.)
            [remove_item]
                x,y=$this_item.x,$this_item.y
                image="items/flower4.png"
            [/remove_item]
            [remove_item]
                x,y=$this_item.x,$this_item.y
                image="items/straw-bale1.png"
            [/remove_item]
            [remove_item]
                x,y=$this_item.x,$this_item.y
                image="items/straw-bale2.png"
            [/remove_item]
            [remove_item]
                x,y=$this_item.x,$this_item.y
                image="items/grain-sheaf.png"
            [/remove_item]

            {VARIABLE sound yes}

            # The terrain was modified.
            # Until redrawing the old one will still be displayed.

            [scroll_to]
                x,y=$this_item.x,$this_item.y
                [filter_side]
                    side=$this_item.side
                [/filter_side]
            [/scroll_to]

            [gold]
                side=$side_number
                amount=$temp_gold
            [/gold]

            [floating_text]
                x,y=$this_item.x,$this_item.y
                text="<span color='#cccc33'>$temp_gold</span>" # wmllint: noconvert
            [/floating_text]
        [/do]
    [/foreach]

    [if]
        {VARIABLE_CONDITIONAL sound boolean_equals yes}
        [then]
            [sound]
                name=gold.ogg
            [/sound]

            [delay]
                time=200
            [/delay]
        [/then]
    [/if]

    {CLEAR_VARIABLE sound,harvesters}

    [foreach]
        array=planters
        [do]
            {MODIFY_TERRAIN_OVERLAY "^Gvs" $this_item.x $this_item.y }

            # There is no item to be expected here, remove item is (or was)
            # for corner cases of the village destruction.
            # In case pickuble items are used on the map it might
            # cause trouble.
            # The corner case is: If an image for destruction is placed there,
            # but no extra action is needed to remove the image again.
            [remove_item]
                x,y=$this_item.x,$this_item.y
            [/remove_item]

            {RANDOM "items/straw-bale1.png,items/straw-bale2.png,items/grain-sheaf.png"}
            [item]
                x,y=$this_item.x,$this_item.y
                image=$random
            [/item]

            {VARIABLE sound yes}
        [/do]
    [/foreach]

    [redraw][/redraw]

    [if]
        {VARIABLE_CONDITIONAL sound boolean_equals yes}
        [then]
            [sound]
                name=entangle.wav
            [/sound]

            [delay]
                time=200
            [/delay]
        [/then]
    [/if]

    {CLEAR_VARIABLE sound,planters,random}
#enddef

# ------------------------------------------------------
# Automatic Mushroom harvest
# ------------------------------------------------------

#define AUTO_MUSHROOM TYPES

    [store_unit]  ## save all peasants who are on Uu^Uf
        [filter]
            type={TYPES} ## if unit is peasant
            side=$side_number  ## of side of who's turn it is
            [not]
                status=worked_this_turn
            [/not]
            [filter_location]
                terrain=*^Tf,*^Tfi,*^Uf,*^Ufi ## if peasant is on regular mushrooms
            [/filter_location]
            [not]
                [filter_adjacent]
                    is_enemy=yes  ## Keep defensive bonus and do not take the 4 gold
                [/filter_adjacent]
            [/not]
        [/filter]
        variable=mushroom_harvesters ## save into this variable $mushroom_harvesters
    [/store_unit]

    [store_unit] ## save all Peasants who are on Uu or Uue or Uue^Ii etc.. (caves)
        [filter]
            type={TYPES}
            side=$side_number
            [not]
                status=worked_this_turn
            [/not]
            [filter_location]
                terrain=Uu,Uue,Uue^Ii,Uu^Ii ## all types of caves
            [/filter_location]
        [/filter]
        variable=mushroom_planters ## into $mushroom_planters array
    [/store_unit]

    #----------------------------------------------------------------
                # auto-harvest
    [foreach]
        array=mushroom_harvesters
        [do]
            {MODIFY_TERRAIN_OVERLAY "^" $this_item.x $this_item.y}
            [gold]
                side=$side_number
                amount=4
            [/gold]

            [scroll_to]
                x,y=$this_item.x,$this_item.y
                [filter_side]
                    side=$this_item.side
                [/filter_side]
            [/scroll_to]

            {VARIABLE sound yes}
            [floating_text]
                x,y=$this_item.x,$this_item.y
                text="<span color='#cccc33'>4</span>"  # wmllint: noconvert
            [/floating_text]
        [/do]
    [/foreach]

    [if]
        {VARIABLE_CONDITIONAL sound boolean_equals yes}
        [then]
            [sound]
                name=gold.ogg
            [/sound]

            [delay]
                time=200
            [/delay]
        [/then]
    [/if]

    {CLEAR_VARIABLE sound,mushroom_harvesters}

    #-------------------------------------------------
                # auto-plant

    [foreach]
        array=mushroom_planters
        [do]
            [if]
                [have_location]
                    terrain=*^Ii
                    x=$this_item.x
                    y=$this_item.y
                [/have_location]
                [then]
                    {MODIFY_TERRAIN_OVERLAY "^Tfi" $this_item.x $this_item.y }
                [/then]
                [else]
                    {MODIFY_TERRAIN_OVERLAY "^Tf" $this_item.x $this_item.y }
                [/else]
            [/if]

            {VARIABLE sound yes}
        [/do]
    [/foreach]

    [if]
        {VARIABLE_CONDITIONAL sound boolean_equals yes}
        [then]
            [sound]
                name=entangle.wav
            [/sound]

            [delay]
                time=200
            [/delay]
        [/then]
    [/if]

    {CLEAR_VARIABLE sound,mushroom_planters}
#enddef

# ------------------------------------------------------
# Automatic Mining
# ------------------------------------------------------

#define AUTO_MINING TYPES
    [store_unit]
        [filter]
            type={TYPES}
            side=$side_number
            [filter_location]
                terrain=H*^Vhh,H*^Vhha,H*^Hhhr,M*^Vhh,M*^Vhha,M*^Vhhr
            [/filter_location]
        [/filter]
        variable=miners
    [/store_unit]

    [foreach]
        array=miners
        [do]
            [gold]
                side=$side_number
                amount=$player_$side_number|.mining.gold
            [/gold]

            [scroll_to]
                x,y=$this_item.x,$this_item.y
                [filter_side]
                    side=$this_item.side
                [/filter_side]
            [/scroll_to]

            {VARIABLE sound yes}

            [floating_text]
                x,y=$this_item.x,$this_item.y
                text="<span color='#cccc33'>$player_$side_number|.mining.gold</span>"  # wmllint: noconvert
            [/floating_text]
        [/do]
    [/foreach]

    [if]
        {VARIABLE_CONDITIONAL sound boolean_equals yes}
        [then]
            [sound]
                name=gold.ogg
            [/sound]

            [delay]
                time=200
            [/delay]
        [/then]
    [/if]

    {CLEAR_VARIABLE sound,miners}
#enddef

# ------------------------------------------------------
# Automatic Hunting
# ------------------------------------------------------

#define AUTO_HUNTING TYPES
    [store_unit]
        [filter]
            type={TYPES}
            side=$side_number
            canrecruit=no
            [not]
                status=worked_this_turn
            [/not]
            [filter_location]
                terrain=*^F*
            [/filter_location]
        [/filter]
        variable=hunters
    [/store_unit]

    [foreach]
        array=hunters
        [do]
            [gold]
                side=$side_number
                amount="$($this_item.level + 1)"
            [/gold]

            {VARIABLE sound yes}

            [scroll_to]
                x,y=$this_item.x,$this_item.y
                [filter_side]
                    side=$this_item.side
                [/filter_side]
            [/scroll_to]

            [floating_text]
                x,y=$this_item.x,$this_item.y
                text="<span color='#cccc33'>$($this_item.level + 1)</span>"  # wmllint: noconvert
            [/floating_text]
        [/do]
    [/foreach]

    [if]
        {VARIABLE_CONDITIONAL sound boolean_equals yes}
        [then]
            [sound]
                name=gold.ogg
            [/sound]

            [delay]
                time=200
            [/delay]
        [/then]
    [/if]

    {CLEAR_VARIABLE sound,hunters}
#enddef

#define AUTO_LUMBER TYPES
    [store_unit]
        [filter]
            type={TYPES}
            side=$side_number
            canrecruit=no
            [not]
                status=worked_this_turn
            [/not]
            [filter_location]
                terrain=*^F*
            [/filter_location]
        [/filter]
        variable=lumberjacks
    [/store_unit]

    [foreach]
        array=lumberjacks
        [do]
            [gold]
                side=$side_number
                amount=1
            [/gold]

            {VARIABLE sound yes}

            [scroll_to]
                x,y=$this_item.x,$this_item.y
                [filter_side]
                    side=$this_item.side
                [/filter_side]
            [/scroll_to]

            [floating_text]
                x,y=$this_item.x,$this_item.y
                text="<span color='#cccc33'>1</span>"  # wmllint: noconvert
            [/floating_text]
        [/do]
    [/foreach]

    [if]
        {VARIABLE_CONDITIONAL sound boolean_equals yes}
        [then]
            [sound]
                name=gold.ogg
            [/sound]

            [delay]
                time=200
            [/delay]
        [/then]
    [/if]

    {CLEAR_VARIABLE sound,lumberjacks}
#enddef

# ------------------------------------------------------
# Automatic Hunting
# ------------------------------------------------------
# Happens when they did not build on the previous turn.

#define AUTO_FISHING TYPES
    [store_unit]
        [filter]
            type={TYPES}
            side=$side_number
            canrecruit=no
            [not]
                status=worked_this_turn
            [/not]
            [filter_location]
                terrain=!,*^V*,!,W*^*,S*^*,*^Do
            [/filter_location]
        [/filter]
        variable=fishers
    [/store_unit]

    [foreach]
        array=fishers
        [do]
            [gold]
                side=$side_number
                amount=1
            [/gold]

            {VARIABLE sound yes}

            [scroll_to]
                x,y=$this_item.x,$this_item.y
                [filter_side]
                    side=$this_item.side
                [/filter_side]
            [/scroll_to]

            [floating_text]
                x,y=$this_item.x,$this_item.y
                text="<span color='#cccc33'>1</span>"  # wmllint: noconvert
            [/floating_text]
        [/do]
    [/foreach]

    [if]
        {VARIABLE_CONDITIONAL sound boolean_equals yes}
        [then]
            [sound]
                name=gold.ogg
            [/sound]

            [delay]
                time=200
            [/delay]
        [/then]
    [/if]

    {CLEAR_VARIABLE sound,fishers}
#enddef

# ------------------------------------------------------
# Remove working status from any working units when starting a turn
# ------------------------------------------------------

#define AUTO_RELAXING
    [store_unit]
        [filter]
            side=$side_number
            status=worked_this_turn
        [/filter]

        variable=this_side_workers
    [/store_unit]
    [foreach]
        array=this_side_workers
        [do]
            {CLEAR_VARIABLE this_item.status.worked_this_turn}
            [unstore_unit]
                variable=this_item
            [/unstore_unit]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE this_side_workers}
#enddef

# ------------------------------------------------------
# Disable building directly after recruitment or creation via plague.
# Nested in a turn 1 event, to not modify units placed at game start (if any).
# It needs to use »unit placed« to also modify walking corpses created by combat.
#
# When adding the possibility to remove villages with a worker option, it should also trigger on »capture«.
# This is to avoid a player capturing an enemy village and destroying it immediately with the worker option.
# ------------------------------------------------------

#define AUTO_BREAKFASTING TYPES
    [event]
        name=turn 1

        [event]
            name=unit placed # ,capture
            first_time_only=no
            # Filter avoids triggering in unnecessary cases,
            # otherwise it would block them from undoing.
            [filter]
                {TYPES}
                [not]
                    status=worked_this_turn
                [/not]
            [/filter]

            [modify_unit]
                [filter]
                    id=$unit.id
                [/filter]
                [status]
                    worked_this_turn=yes
                [/status]
            [/modify_unit]

            # Allowed to undo, because first_time_only=no
#ifver WESNOTH_VERSION < 1.18.0
            [allow_undo][/allow_undo]
#endif
#ifver WESNOTH_VERSION >= 1.19.2
            [allow_undo][/allow_undo]
#endif
        [/event]
    [/event]
#enddef

#define AUTO_CLEANUP TYPES
    [store_unit]
        [filter]
            type={TYPES}
            side=$side_number
            canrecruit=no
            [not]
                status=worked_this_turn
            [/not]
            [filter_location]
                terrain=!,Rd^Es,!,*^Es
            [/filter_location]
        [/filter]
        variable=worker1
    [/store_unit]

    [store_unit]
        [filter]
            type={TYPES}
            side=$side_number
            canrecruit=no
            [not]
                status=worked_this_turn
            [/not]
            [filter_location]
                terrain=Rb
            [/filter_location]
        [/filter]
        variable=worker2
    [/store_unit]

    [store_unit]
        [filter]
            type={TYPES}
            side=$side_number
            canrecruit=no
            [not]
                status=worked_this_turn
            [/not]
            [filter_location]
                terrain=Rd,Rd^Es
            [/filter_location]
        [/filter]
        variable=worker3
    [/store_unit]

    [foreach]
        array=worker1
        [do]
            [terrain]
                terrain="^"
                layer=overlay
                x=$this_item.x
                y=$this_item.y
            [/terrain]
        [/do]
    [/foreach]

    [foreach]
        array=worker2
        [do]
            [terrain]
                terrain=Gg
                x=$this_item.x
                y=$this_item.y
            [/terrain]
        [/do]
    [/foreach]

    [foreach]
        array=worker3
        [do]
            # This does not give a variable value (which exists only at runtime) to the macro (which exists only before the game was started)
            # It gives the variable name to the macro, which will be used at runtime.
            {REMOVE_IMAGE_OF_BURNED_DOWN_VILLAGE X=$this_item.x Y=$this_item.y}
            [terrain]
                terrain=Gg
                x=$this_item.x
                y=$this_item.y
            [/terrain]
        [/do]
    [/foreach]

    [modify_unit]
        [filter]
            type={TYPES}
            side=$side_number
            canrecruit=no
            [not]
                status=worked_this_turn
            [/not]
            [filter_location]
                terrain=Rb,Rd,*^Es
            [/filter_location]
        [/filter]
        [status]
            worked_this_turn=yes
        [/status]
    [/modify_unit]

    {CLEAR_VARIABLE worker1,worker2,worker3}
#enddef
